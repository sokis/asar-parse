"use strict";function _interopDefault(r){return r&&"object"==typeof r&&"default"in r?r.default:r}function getFileFromArchive(r,e){var a=path.relative(arch.src,r),t=void 0;try{var n=arch.searchNodeFromDirectory(a);if(n&&n.size){var i=void 0;e&&"string"==typeof e&&(i=e),t=asar.extractFile(arch.src,a),i&&(t=t.toString(i))}}catch(r){}return t}function readPackage(r){if(Object.prototype.hasOwnProperty.call(packageMainCache,r))return packageMainCache[r];var e=tools.join(r,"package.json"),a=void 0;try{a=asar.extractFile(arch.src,e)}catch(r){return!1}if(void 0===a)return!1;var t=void 0;try{packageMainCache[e]=JSON.parse(a).main,t=packageMainCache[e]}catch(r){throw r.path=e,r.message="Error parsing "+e+": "+r.message,r}return t}function parseAsarPath(r){var e=r.indexOf(".asar");return-1==e?r:tools.norm(r.substr(e+6))}function tryFile(r){try{var e=arch.searchNodeFromDirectory(r);if(e&&e.size)return r}catch(r){}return!1}function tryExtensions(r,e){for(var a=0;a<e.length;a++){var t=tryFile(r+e[a]);if(t)return t}return!1}function tryPackage(r,e){var a=readPackage(r);if(!a)return!1;var t=tools.join(r,a);return tryFile(t)||tryExtensions(t,e)||tryExtensions(tools.join(t,"index"),e)}var path=_interopDefault(require("path")),asar=_interopDefault(require("asar")),disk=_interopDefault(require("asar/lib/disk")),Module=_interopDefault(require("module")),classCallCheck=function(r,e){if(!(r instanceof e))throw new TypeError("Cannot call a class as a function")},createClass=function(){function r(r,e){for(var a=0;a<e.length;a++){var t=e[a];t.enumerable=t.enumerable||!1,t.configurable=!0,"value"in t&&(t.writable=!0),Object.defineProperty(r,t.key,t)}}return function(e,a,t){return a&&r(e.prototype,a),t&&r(e,t),e}}(),arch=null,original={},packageMainCache={},tools={norm:function(r){return r.replace(/\\/g,"/")},join:function(r,e){return tools.norm(path.join(r,e))}},hooks={fs:{readFileSync:function(r,e){if(-1==r.indexOf(".asar"))return original.fs.readFileSync(r,e);var a=getFileFromArchive(r,e);return a||void 0},readFile:function(r,e,a){return original.fs.readFile(r,e,function(t,n){var i=maybeCallback(a);if(!t)return i(t,n);if(t&&-2===t.errno&&"open"===t.syscall){var o=getFileFromArchive(r,e);if(o)return i(null,o)}return i(t,n)})}},module:{_findPath:function(r,e){var a=original.module._findPath(r,e);if(a)return a;var t=Object.keys(Module._extensions);"/"===r.charAt(0)&&(e=[""]);var n="/"===r.slice(-1),i=JSON.stringify({request:r,paths:e});if(Module._pathCache[i])return Module._pathCache[i];var o=path.resolve(arch.src,"..");return(a=e.reduce(function(e,a){var i=void 0;if(e)return e;var c=path.relative(o,a);if(/^\./.test(c))return e;var s=parseAsarPath(path.join(c,r));return!!s&&(n||(i=tryFile(s))||(i=tryExtensions(s,t)),i||(i=tryPackage(s,t)),i||(i=tryExtensions(tools.join(s,"index"),t)),i)},a))&&(a=path.join(arch.src,a),Module._pathCache[i]=a),a}}},AsarParse=function(){function r(e){classCallCheck(this,r),arch=disk.readFilesystemSync(e),this.archive=arch.src}return createClass(r,[{key:"patch",value:function(){return Object.keys(hooks).forEach(function(r){var e=require(r),a=Object.keys(hooks[r]);original[r]={},a.forEach(function(a){original[r][a]=e[a],e[a]=hooks[r][a].bind(e)})}),this}},{key:"unpatch",value:function(){return Object.keys(hooks).forEach(function(r){var e=require(r);Object.keys(hooks[r]).forEach(function(a){e[a]=original[r][a],delete original[r][a]}),delete original[r]}),this}}]),r}();module.exports=AsarParse;
